# План работы над Telegram-ботом для учета расходов

## Версионный лог

### 2025-01-27 - Начало разработки
**Промпт:** Создать Telegram-бота для учета расходов с поддержкой текста/голоса/картинок через OpenAI API

**Решение:**
- SQLite для хранения данных
- AI автоматически извлекает сумму из текста/голоса/картинки
- Команды /today и /month для summary
- Описание покупки не сохраняется, только сумма

**Сделано:**
- Создана структура проекта с модулями: bot.py, config.py, openai_client.py, storage.py, expense_parser.py
- Настроены зависимости (requirements.txt)
- Реализована конфигурация через .env файл
- Реализован OpenAI клиент с поддержкой Whisper (транскрипция), GPT-4o (OCR и парсинг)
- Реализовано SQLite хранилище расходов
- Реализован парсер суммы из текста через GPT-4o
- Реализован основной бот с обработчиками текста, голоса и фото
- Реализованы команды /today и /month для summary
- Добавлена обработка ошибок в обработчиках
- Создан README с инструкциями по установке и использованию
- Добавлен .gitignore для защиты чувствительных данных

### 2025-01-27 - Запуск через uv
**Действие:** Настройка и запуск проекта через uv менеджер пакетов
**Сделано:**
- Создано виртуальное окружение через uv venv
- Установлены зависимости через uv pip install
- Создан скрипт run.sh для удобного запуска
- Обновлен README с инструкциями по использованию uv
- Проверено: бот требует файл .env с токенами для работы

### 2025-01-27 - Инициализация Git и коммит
**Действие:** Инициализация git репозитория и коммит всех файлов проекта
**Сделано:**
- Инициализирован git репозиторий
- Закоммичены все файлы проекта (кроме .env, который в .gitignore)

### 2025-11-01 18:21 - Исправление парсинга сумм в разных валютах
**Промпт:** Бот не понимает сколько я потратил (я живу в аргентине). Распознано: "15 тысяч песо в кафешке потратили во время обеда". Не удалось извлечь сумму расхода.
**Проблема:** Бот не извлекает сумму из сообщений с аргентинскими песо и словесными формами чисел ("15 тысяч песо"), потому что промпт в `parse_expense_from_text` жестко требует "сумму в рублях".
**Сделано:**
- ✅ Обновлен промпт в `parse_expense_from_text` для поддержки разных валют (рубли, песо, доллары и т.д.)
- ✅ Добавлена поддержка словесных форм чисел ("15 тысяч" = 15000, "тысяч" = умножить на 1000)
- ✅ Обновлен системный промпт для более гибкого извлечения сумм из текста

### 2025-11-01 18:22 - Добавление логирования для сервера
**Промпт:** Добавь логирование плз для сервера
**Сделано:**
- ✅ Настроена базовая конфигурация логирования в `bot.py` (вывод в файл `bot.log` и консоль)
- ✅ Добавлено логирование всех команд бота (`/start`, `/help`, `/today`, `/month`)
- ✅ Добавлено логирование обработки текстовых, голосовых сообщений и фото
- ✅ Добавлено логирование ошибок с полным traceback
- ✅ Добавлено логирование запросов к OpenAI API в `openai_client.py` (транскрипция, OCR, парсинг)
- ✅ Добавлено логирование операций с базой данных в `storage.py` (инициализация, добавление расходов)
- ✅ Добавлен `bot.log` в `.gitignore`

### 2025-11-01 18:25 - Добавление поддержки разных валют
**Промпт:** Распознано: "20 тысяч песо". Расход 20000.00 руб. сохранен. песо считается рублями почемуто
**Проблема:** Бот извлекал сумму из текста, но не сохранял валюту, всегда показывал "руб." в ответах пользователю
**Сделано:**
- ✅ Изменена функция `parse_expense_from_text` для извлечения суммы и валюты (возвращает tuple)
- ✅ Обновлена функция `extract_expense` для возврата суммы и валюты
- ✅ Добавлено поле `currency` в таблицу БД с автоматической миграцией
- ✅ Обновлена функция `add_expense` для сохранения валюты
- ✅ Обновлены функции `get_expenses_by_date` и `get_monthly_expenses` для группировки по валютам (возвращают dict)
- ✅ Обновлены функции `get_today_total` и `get_month_total` для возврата словаря с валютами
- ✅ Обновлены все ответы бота для отображения правильной валюты
- ✅ Добавлена функция `get_currency_name` для преобразования кодов валют в читаемые названия
- ✅ Обновлены команды `/today` и `/month` для отображения расходов по каждой валюте отдельно

### 2025-11-01 18:26 - Подавление HTTP-логов от библиотеки telegram
**Промпт:** реквесты вроде "HTTP Request: POST https://api.telegram.org..." обычно не надо логировать и писать их в консоль
**Сделано:**
- ✅ Установлен уровень WARNING для логгеров `telegram`, `httpcore`, `httpx`, `urllib3` для подавления HTTP-запросов

### 2025-11-01 18:30 - Добавление определения категорий трат через AI
**Промпт:** бот с помощью аи должен определять категорию траты
**Сделано:**
- ✅ Добавлена функция `determine_expense_category` в `openai_client.py` для определения категории через GPT-4o
- ✅ Добавлено поле `category` в таблицу БД с автоматической миграцией (по умолчанию "другие" для существующих записей)
- ✅ Обновлена функция `add_expense` в `storage.py` для приема и сохранения категории
- ✅ Добавлена функция `extract_expense_with_category` в `expense_parser.py` для возврата суммы, валюты и категории
- ✅ Обновлены все обработчики в `bot.py` (`handle_text`, `handle_voice`, `handle_photo`) для определения и отображения категории
- ✅ Категория теперь отображается в ответе пользователю в формате "Расход X руб. (категория) сохранен."
- ✅ Доступные категории: еда, транспорт, развлечения, коммунальные, одежда, здоровье, другие

### 2025-11-01 21:01 - Добавление автоматического отображения меню команд
**Промпт:** добавь автоматическое отображение меню в телеграме
**План:**
- [x] Обновить план работы в work-plan.md с новой задачей
- [x] Добавить импорт BotCommand в bot.py
- [x] Создать функцию для установки меню команд при запуске бота
- [x] Вызвать функцию установки меню в main() перед запуском бота
**Сделано:**
- ✅ Добавлен импорт BotCommand из telegram
- ✅ Создана асинхронная функция set_bot_commands для установки меню команд
- ✅ Настроено автоматическое отображение меню с командами: /start, /help, /today, /month
- ✅ Функция вызывается через post_init хука при запуске бота
- ✅ Добавлено логирование установки меню команд

### 2025-11-01 21:30 - Добавление категорий в саммари и конвертация валют
**Промпт:** добавить отображение категорий в саммари. и при каждой трате категория должна автоматически определяться
**Проблема:** Категории уже определяются автоматически и отображаются при добавлении расхода, но не показываются в командах /today и /month. Все расходы должны быть пересчитаны в песо (ARS).
**Сделано:**
- ✅ Добавлена функция get_exchange_rates в storage.py для получения актуальных курсов валют через API exchangerate-api.com
- ✅ Добавлена функция convert_to_ars для конвертации любых валют в ARS с использованием курсов из API
- ✅ Обновлены функции get_expenses_by_date и get_monthly_expenses для группировки по категориям с автоматической конвертацией в ARS
- ✅ Обновлены команды today_summary и month_summary для отображения разбивки по категориям в песо
- ✅ Обновлены обработчики handle_text, handle_voice, handle_photo для отображения суммы в песо при добавлении расхода
- ✅ Если расход был в другой валюте, показывается конвертация: "Расход X валюта (Y песо) в категории Z сохранен"

### 2025-01-27 23:00 - Добавление меню настройки валюты
**Промпт:** мне нужно меню настройки в котором можно менять отображение валюты
**Решение:**
- Таблица user_settings для хранения настроек пользователя (валюта отображения и курсы)
- Команда /settings с inline-клавиатурой для выбора валюты отображения (USD, RUB, ARS)
- Команда /setrate для ручной установки курсов валют (например, /setrate USD 1000)
- Конвертация всех сумм в выбранную валюту пользователя
**Сделано:**
- ✅ Добавлена таблица user_settings в storage.py (user_id, display_currency, usd_to_ars_rate, rub_to_ars_rate)
- ✅ Добавлена функция init_user_settings_table для создания таблицы настроек
- ✅ Добавлена функция get_user_settings для получения настроек пользователя
- ✅ Добавлена функция set_display_currency для установки валюты отображения
- ✅ Добавлена функция set_exchange_rate для установки курсов валют
- ✅ Добавлена функция convert_currency для конвертации с учетом пользовательских курсов и валюты отображения
- ✅ Обновлены функции get_expenses_by_date и get_monthly_expenses для конвертации в валюту пользователя
- ✅ Обновлены функции get_today_total и get_month_total для приема user_id
- ✅ Добавлена команда /settings с inline-клавиатурой для выбора валюты
- ✅ Добавлен обработчик callback для выбора валюты в меню настроек
- ✅ Добавлена команда /setrate для ручной установки курсов (формат: /setrate USD 1000)
- ✅ Обновлены все функции отображения сумм (handle_text, handle_voice, handle_photo, today_summary, month_summary)
- ✅ Обновлено меню команд бота: добавлены /settings и /setrate
- ✅ Обновлена команда /help для отображения новых команд

## Задачи

- [x] Создать структуру проекта
- [x] Настроить зависимости (requirements.txt)
- [x] Реализовать конфигурацию (.env)
- [x] Реализовать OpenAI клиент (Whisper транскрипция, GPT-4 Vision OCR, GPT-4 парсинг суммы)
- [x] Реализовать SQLite хранилище расходов
- [x] Реализовать парсер суммы из ответа AI
- [x] Реализовать основной бот с обработчиками
- [x] Реализовать команды summary
- [x] Добавить обработку ошибок
- [x] Создать README с инструкциями

