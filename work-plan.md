# План работы над Telegram-ботом для учета расходов

## Версионный лог

### 2025-01-27 - Начало разработки
**Промпт:** Создать Telegram-бота для учета расходов с поддержкой текста/голоса/картинок через OpenAI API

**Решение:**
- SQLite для хранения данных
- AI автоматически извлекает сумму из текста/голоса/картинки
- Команды /today и /month для summary
- Описание покупки не сохраняется, только сумма

**Сделано:**
- Создана структура проекта с модулями: bot.py, config.py, openai_client.py, storage.py, expense_parser.py
- Настроены зависимости (requirements.txt)
- Реализована конфигурация через .env файл
- Реализован OpenAI клиент с поддержкой Whisper (транскрипция), GPT-4o (OCR и парсинг)
- Реализовано SQLite хранилище расходов
- Реализован парсер суммы из текста через GPT-4o
- Реализован основной бот с обработчиками текста, голоса и фото
- Реализованы команды /today и /month для summary
- Добавлена обработка ошибок в обработчиках
- Создан README с инструкциями по установке и использованию
- Добавлен .gitignore для защиты чувствительных данных

### 2025-01-27 - Запуск через uv
**Действие:** Настройка и запуск проекта через uv менеджер пакетов
**Сделано:**
- Создано виртуальное окружение через uv venv
- Установлены зависимости через uv pip install
- Создан скрипт run.sh для удобного запуска
- Обновлен README с инструкциями по использованию uv
- Проверено: бот требует файл .env с токенами для работы

### 2025-01-27 - Инициализация Git и коммит
**Действие:** Инициализация git репозитория и коммит всех файлов проекта
**Сделано:**
- Инициализирован git репозиторий
- Закоммичены все файлы проекта (кроме .env, который в .gitignore)

### 2025-11-01 18:21 - Исправление парсинга сумм в разных валютах
**Промпт:** Бот не понимает сколько я потратил (я живу в аргентине). Распознано: "15 тысяч песо в кафешке потратили во время обеда". Не удалось извлечь сумму расхода.
**Проблема:** Бот не извлекает сумму из сообщений с аргентинскими песо и словесными формами чисел ("15 тысяч песо"), потому что промпт в `parse_expense_from_text` жестко требует "сумму в рублях".
**Сделано:**
- ✅ Обновлен промпт в `parse_expense_from_text` для поддержки разных валют (рубли, песо, доллары и т.д.)
- ✅ Добавлена поддержка словесных форм чисел ("15 тысяч" = 15000, "тысяч" = умножить на 1000)
- ✅ Обновлен системный промпт для более гибкого извлечения сумм из текста

### 2025-11-01 18:22 - Добавление логирования для сервера
**Промпт:** Добавь логирование плз для сервера
**Сделано:**
- ✅ Настроена базовая конфигурация логирования в `bot.py` (вывод в файл `bot.log` и консоль)
- ✅ Добавлено логирование всех команд бота (`/start`, `/help`, `/today`, `/month`)
- ✅ Добавлено логирование обработки текстовых, голосовых сообщений и фото
- ✅ Добавлено логирование ошибок с полным traceback
- ✅ Добавлено логирование запросов к OpenAI API в `openai_client.py` (транскрипция, OCR, парсинг)
- ✅ Добавлено логирование операций с базой данных в `storage.py` (инициализация, добавление расходов)
- ✅ Добавлен `bot.log` в `.gitignore`

### 2025-11-01 18:25 - Добавление поддержки разных валют
**Промпт:** Распознано: "20 тысяч песо". Расход 20000.00 руб. сохранен. песо считается рублями почемуто
**Проблема:** Бот извлекал сумму из текста, но не сохранял валюту, всегда показывал "руб." в ответах пользователю
**Сделано:**
- ✅ Изменена функция `parse_expense_from_text` для извлечения суммы и валюты (возвращает tuple)
- ✅ Обновлена функция `extract_expense` для возврата суммы и валюты
- ✅ Добавлено поле `currency` в таблицу БД с автоматической миграцией
- ✅ Обновлена функция `add_expense` для сохранения валюты
- ✅ Обновлены функции `get_expenses_by_date` и `get_monthly_expenses` для группировки по валютам (возвращают dict)
- ✅ Обновлены функции `get_today_total` и `get_month_total` для возврата словаря с валютами
- ✅ Обновлены все ответы бота для отображения правильной валюты
- ✅ Добавлена функция `get_currency_name` для преобразования кодов валют в читаемые названия
- ✅ Обновлены команды `/today` и `/month` для отображения расходов по каждой валюте отдельно

### 2025-11-01 18:26 - Подавление HTTP-логов от библиотеки telegram
**Промпт:** реквесты вроде "HTTP Request: POST https://api.telegram.org..." обычно не надо логировать и писать их в консоль
**Сделано:**
- ✅ Установлен уровень WARNING для логгеров `telegram`, `httpcore`, `httpx`, `urllib3` для подавления HTTP-запросов

### 2025-11-01 18:30 - Добавление определения категорий трат через AI
**Промпт:** бот с помощью аи должен определять категорию траты
**Сделано:**
- ✅ Добавлена функция `determine_expense_category` в `openai_client.py` для определения категории через GPT-4o
- ✅ Добавлено поле `category` в таблицу БД с автоматической миграцией (по умолчанию "другие" для существующих записей)
- ✅ Обновлена функция `add_expense` в `storage.py` для приема и сохранения категории
- ✅ Добавлена функция `extract_expense_with_category` в `expense_parser.py` для возврата суммы, валюты и категории
- ✅ Обновлены все обработчики в `bot.py` (`handle_text`, `handle_voice`, `handle_photo`) для определения и отображения категории
- ✅ Категория теперь отображается в ответе пользователю в формате "Расход X руб. (категория) сохранен."
- ✅ Доступные категории: еда, транспорт, развлечения, коммунальные, одежда, здоровье, другие

### 2025-11-01 21:01 - Добавление автоматического отображения меню команд
**Промпт:** добавь автоматическое отображение меню в телеграме
**План:**
- [x] Обновить план работы в work-plan.md с новой задачей
- [x] Добавить импорт BotCommand в bot.py
- [x] Создать функцию для установки меню команд при запуске бота
- [x] Вызвать функцию установки меню в main() перед запуском бота
**Сделано:**
- ✅ Добавлен импорт BotCommand из telegram
- ✅ Создана асинхронная функция set_bot_commands для установки меню команд
- ✅ Настроено автоматическое отображение меню с командами: /start, /help, /today, /month
- ✅ Функция вызывается через post_init хука при запуске бота
- ✅ Добавлено логирование установки меню команд

## Задачи

- [x] Создать структуру проекта
- [x] Настроить зависимости (requirements.txt)
- [x] Реализовать конфигурацию (.env)
- [x] Реализовать OpenAI клиент (Whisper транскрипция, GPT-4 Vision OCR, GPT-4 парсинг суммы)
- [x] Реализовать SQLite хранилище расходов
- [x] Реализовать парсер суммы из ответа AI
- [x] Реализовать основной бот с обработчиками
- [x] Реализовать команды summary
- [x] Добавить обработку ошибок
- [x] Создать README с инструкциями

